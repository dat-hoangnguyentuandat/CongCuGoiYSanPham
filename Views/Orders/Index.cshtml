@{
    ViewData["Title"] = "Đơn hàng của tôi";
}

<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="fw-bold text-primary mb-4">
                <i class="fas fa-box me-2"></i>Đơn hàng của tôi
            </h2>
        </div>
    </div>
    
    <div class="card shadow-sm border-0 rounded-4 mb-4">
        <div class="card-body p-4">
            <ul class="nav nav-pills justify-content-center">
                <li class="nav-item">
                    <a class="nav-link active rounded-pill px-4" href="#" onclick="filterOrders('all')">
                        <i class="fas fa-list me-2"></i>Tất cả
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link rounded-pill px-4" href="#" onclick="filterOrders('Pending')">
                        <i class="fas fa-clock me-2"></i>Chờ xác nhận
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link rounded-pill px-4" href="#" onclick="filterOrders('Confirmed')">
                        <i class="fas fa-check me-2"></i>Đã xác nhận
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link rounded-pill px-4" href="#" onclick="filterOrders('Shipping')">
                        <i class="fas fa-shipping-fast me-2"></i>Đang giao
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link rounded-pill px-4" href="#" onclick="filterOrders('Delivered')">
                        <i class="fas fa-check-circle me-2"></i>Đã giao
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link rounded-pill px-4" href="#" onclick="filterOrders('Cancelled')">
                        <i class="fas fa-times me-2"></i>Đã hủy
                    </a>
                </li>
            </ul>
        </div>
    </div>
    
    <div id="ordersList">
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Đang tải đơn hàng...</p>
        </div>
    </div>
</div>

@section Scripts {
    <style>
        .hover-lift {
            transition: all 0.3s ease;
        }
        
        .hover-lift:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .card {
            transition: all 0.3s ease;
            border: none;
        }
        
        .rounded-4 {
            border-radius: 1rem !important;
        }
        
        .rounded-pill {
            border-radius: 50rem !important;
        }
        
        .text-primary {
            color: #667eea !important;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }
        
        .nav-pills .nav-link {
            color: #6c757d;
            transition: all 0.3s ease;
        }
        
        .nav-pills .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .nav-pills .nav-link:hover {
            background-color: #f8f9fa;
            color: #667eea;
        }
        
        .badge {
            font-weight: 500;
        }
    </style>
    
    <script>
        let allOrders = [];

        async function loadOrders() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/orders', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                allOrders = await response.json();
                displayOrders(allOrders);
            } catch (error) {
                console.error('Error loading orders:', error);
                document.getElementById('ordersList').innerHTML = '<p class="text-center text-danger">Lỗi tải đơn hàng</p>';
            }
        }

        function displayOrders(orders) {
            if (!orders || orders.length === 0) {
                document.getElementById('ordersList').innerHTML = `
                    <div class="card border-0 rounded-4 shadow-sm">
                        <div class="card-body text-center py-5">
                            <i class="fas fa-box-open fa-4x text-muted mb-4"></i>
                            <h4 class="text-muted mb-3">Chưa có đơn hàng nào</h4>
                            <p class="text-muted mb-4">Hãy đặt hàng để theo dõi đơn hàng của bạn</p>
                            <a href="/Products" class="btn btn-primary rounded-pill px-4 hover-lift">
                                <i class="fas fa-shopping-bag me-2"></i>Mua sắm ngay
                            </a>
                        </div>
                    </div>
                `;
                return;
            }

            const ordersHtml = orders.map(order => `
                <div class="card mb-4 border-0 rounded-4 shadow-sm hover-lift">
                    <div class="card-header bg-light rounded-top-4 border-0 p-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-1 fw-bold text-primary">
                                    <i class="fas fa-receipt me-2"></i>Đơn hàng: ${order.orderNumber}
                                </h5>
                                <small class="text-muted">
                                    <i class="fas fa-calendar me-1"></i>
                                    ${new Date(order.createdAt).toLocaleString('vi-VN')}
                                </small>
                            </div>
                            <span class="badge ${getStatusBadgeClass(order.status)} rounded-pill px-3 py-2 fs-6">${getStatusText(order.status)}</span>
                        </div>
                    </div>
                    <div class="card-body p-4">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <p class="mb-2">
                                    <i class="fas fa-box text-primary me-2"></i>
                                    <strong>Số lượng:</strong> ${order.itemCount} sản phẩm
                                </p>
                                <p class="mb-0">
                                    <i class="fas fa-money-bill-wave text-success me-2"></i>
                                    <strong>Tổng tiền:</strong> 
                                    <span class="text-danger fw-bold fs-5">${formatPrice(order.totalAmount)}</span>
                                </p>
                            </div>
                            <div class="col-md-6 text-end">
                                <div class="d-flex gap-2 justify-content-end">
                                    <a href="/Orders/Detail/${order.id}" class="btn btn-primary rounded-pill px-4 hover-lift">
                                        <i class="fas fa-eye me-2"></i> Xem chi tiết
                                    </a>
                                    ${order.status === 'Pending' || order.status === 'Confirmed' ? `
                                        <button class="btn btn-outline-danger rounded-pill px-4 hover-lift" onclick="cancelOrder(${order.id})">
                                            <i class="fas fa-times me-2"></i> Hủy đơn
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            document.getElementById('ordersList').innerHTML = ordersHtml;
        }

        function filterOrders(status) {
            // Update active tab
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            event.target.classList.add('active');

            if (status === 'all') {
                displayOrders(allOrders);
            } else {
                const filtered = allOrders.filter(o => o.status === status);
                displayOrders(filtered);
            }
        }

        async function cancelOrder(orderId) {
            if (!confirm('Bạn có chắc muốn hủy đơn hàng này?')) return;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/orders/${orderId}/cancel`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    alert('Đã hủy đơn hàng thành công');
                    loadOrders();
                } else {
                    alert('Không thể hủy đơn hàng');
                }
            } catch (error) {
                console.error('Error cancelling order:', error);
                alert('Có lỗi xảy ra');
            }
        }

        function getStatusBadgeClass(status) {
            const classes = {
                'Pending': 'bg-warning',
                'Confirmed': 'bg-info',
                'Shipping': 'bg-primary',
                'Delivered': 'bg-success',
                'Cancelled': 'bg-danger',
                'Returned': 'bg-secondary'
            };
            return classes[status] || 'bg-secondary';
        }

        function getStatusText(status) {
            const texts = {
                'Pending': 'Chờ xác nhận',
                'Confirmed': 'Đã xác nhận',
                'Shipping': 'Đang giao hàng',
                'Delivered': 'Đã giao hàng',
                'Cancelled': 'Đã hủy',
                'Returned': 'Đã trả hàng'
            };
            return texts[status] || status;
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(price);
        }

        loadOrders();
    </script>
}
