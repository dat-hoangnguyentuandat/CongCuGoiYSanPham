@{
    ViewData["Title"] = "Product Detail";
    var productId = ViewData["ProductId"];
}

<div class="container mt-4">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb bg-light rounded-pill px-4 py-2">
            <li class="breadcrumb-item"><a href="/" class="text-decoration-none">Trang chủ</a></li>
            <li class="breadcrumb-item"><a href="/Products" class="text-decoration-none">Sản phẩm</a></li>
            <li class="breadcrumb-item active" id="breadcrumbProduct">Chi tiết</li>
        </ol>
    </nav>

    <div class="row" id="productDetail">
        <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Đang tải thông tin sản phẩm...</p>
        </div>
    </div>

    <!-- Similar Products -->
    <div class="row mt-5">
        <div class="col-12">
            <h4 class="fw-bold text-primary mb-4">
                <i class="fas fa-heart me-2"></i>Sản phẩm tương tự
            </h4>
        </div>
    </div>
    <div class="row" id="similarProducts">
    </div>
</div>

<!-- Review Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 rounded-4">
            <div class="modal-header bg-primary text-white rounded-top-4">
                <h5 class="modal-title fw-bold">
                    <i class="fas fa-star me-2"></i>Đánh giá sản phẩm
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="reviewForm">
                    <div class="mb-4">
                        <label class="form-label fw-bold">Đánh giá của bạn:</label>
                        <div class="rating-stars mb-3 text-center">
                            <i class="fas fa-star star-rating" data-rating="1"></i>
                            <i class="fas fa-star star-rating" data-rating="2"></i>
                            <i class="fas fa-star star-rating" data-rating="3"></i>
                            <i class="fas fa-star star-rating" data-rating="4"></i>
                            <i class="fas fa-star star-rating" data-rating="5"></i>
                        </div>
                        <small class="text-muted d-block text-center">Nhấn vào sao để đánh giá</small>
                    </div>
                    <div class="mb-3">
                        <label for="reviewComment" class="form-label fw-bold">Nhận xét:</label>
                        <textarea class="form-control rounded-3" id="reviewComment" rows="4" placeholder="Chia sẻ trải nghiệm của bạn về sản phẩm này..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 p-4">
                <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary rounded-pill px-4" onclick="submitReview()">
                    <i class="fas fa-paper-plane me-2"></i>Gửi đánh giá
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <style>
        .rating-stars {
            font-size: 2rem;
            cursor: pointer;
        }
        
        .star-rating {
            color: #ddd;
            transition: all 0.2s ease;
            margin: 0 0.2rem;
        }
        
        .star-rating:hover,
        .star-rating.active {
            color: #ffc107;
            transform: scale(1.1);
        }
        
        .star-rating:hover ~ .star-rating {
            color: #ddd;
        }
        
        .hover-lift {
            transition: all 0.3s ease;
        }
        
        .hover-lift:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .card {
            transition: all 0.3s ease;
            border: none;
        }
        
        .rounded-4 {
            border-radius: 1rem !important;
        }
        
        .rounded-pill {
            border-radius: 50rem !important;
        }
        
        .text-primary {
            color: #667eea !important;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }
        
        .bg-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        }
        
        .badge {
            font-weight: 500;
        }
        
        .product-image {
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .variant-card {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .variant-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .quantity-input {
            border-radius: 0.5rem;
        }
        
        .review-card {
            border-left: 4px solid #667eea;
        }
    </style>
    
    <script>
        const productId = @productId;

        async function loadProductDetail() {
            try {
                const response = await fetch(`/api/products/${productId}`);
                const product = await response.json();
                
                document.getElementById('breadcrumbProduct').textContent = product.name;
                document.title = product.name;
                
                const detailHtml = `
                    <div class="col-md-6 mb-4">
                        <img src="${product.imageUrl || '/images/placeholder.jpg'}" class="img-fluid product-image" alt="${product.name}">
                    </div>
                    <div class="col-md-6">
                        <div class="product-info">
                            <span class="badge bg-primary rounded-pill mb-3 fs-6">${product.categoryName}</span>
                            <h2 class="fw-bold mb-3">${product.name}</h2>
                            <div class="mb-4">
                                <div class="d-flex align-items-center">
                                    <div class="text-warning me-2">
                                        ${Array(5).fill().map((_, i) => `<i class="fas fa-star${i < Math.floor(product.averageRating) ? '' : ' text-muted'}"></i>`).join('')}
                                    </div>
                                    <span class="fw-bold fs-5">${product.averageRating.toFixed(1)}</span>
                                    <span class="text-muted ms-2">(${product.reviewCount} đánh giá)</span>
                                </div>
                            </div>
                            <h3 class="text-danger mb-4 fw-bold">${formatPrice(product.minPrice)} ${product.maxPrice > product.minPrice ? '- ' + formatPrice(product.maxPrice) : ''}</h3>
                            <p class="lead text-muted mb-4">${product.description || ''}</p>
                            
                            <hr class="my-4">
                            
                            <h5 class="fw-bold mb-3">Chọn phiên bản:</h5>
                            <div class="row mb-4" id="variantsList">
                                ${product.variants.map(v => `
                                    <div class="col-md-6 mb-3">
                                        <div class="card variant-card ${v.stockQuantity > 0 ? 'border-primary' : 'border-secondary'}" onclick="selectVariant(${v.id}, ${v.price}, ${v.discountPrice || v.price})">
                                            <div class="card-body p-3">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <strong class="text-primary">${v.size} - ${v.color}</strong><br>
                                                        <small class="text-muted">SKU: ${v.sku}</small>
                                                    </div>
                                                    <div class="text-end">
                                                        <span class="text-danger fw-bold">${formatPrice(v.discountPrice || v.price)}</span><br>
                                                        <small class="${v.stockQuantity > 0 ? 'text-success' : 'text-danger'} fw-bold">${v.stockQuantity > 0 ? 'Còn hàng' : 'Hết hàng'}</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div class="mb-4">
                                <label class="form-label fw-bold">Số lượng:</label>
                                <div class="input-group quantity-input" style="max-width: 150px;">
                                    <button class="btn btn-outline-primary" onclick="changeQuantity(-1)">-</button>
                                    <input type="number" class="form-control text-center" id="quantity" value="1" min="1">
                                    <button class="btn btn-outline-primary" onclick="changeQuantity(1)">+</button>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-3">
                                <button class="btn btn-primary btn-lg rounded-pill hover-lift" onclick="addToCart()">
                                    <i class="fas fa-shopping-cart me-2"></i> Thêm vào giỏ hàng
                                </button>
                                <button class="btn btn-outline-primary btn-lg rounded-pill hover-lift" onclick="buyNow()">
                                    <i class="fas fa-bolt me-2"></i> Mua ngay
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Reviews Section -->
                    <div class="col-12 mt-5">
                        <div class="card border-0 rounded-4 shadow-sm">
                            <div class="card-header bg-light rounded-top-4 border-0">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h4 class="mb-0 fw-bold text-primary">
                                        <i class="fas fa-comments me-2"></i>Đánh giá sản phẩm
                                    </h4>
                                    <button class="btn btn-outline-primary rounded-pill px-4" onclick="showReviewModal()" id="reviewButton">
                                        <i class="fas fa-star me-2"></i> Viết đánh giá
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-4">
                                <div id="reviewsList">
                                    ${product.reviews.length > 0 ? product.reviews.map(r => `
                                        <div class="card review-card mb-3 border-0 shadow-sm">
                                            <div class="card-body p-4">
                                                <div class="d-flex justify-content-between mb-3">
                                                    <div>
                                                        <strong class="text-primary">${r.userName}</strong>
                                                        ${r.isVerifiedPurchase ? '<span class="badge bg-success ms-2 rounded-pill">Đã mua hàng</span>' : ''}
                                                    </div>
                                                    <small class="text-muted">${new Date(r.createdAt).toLocaleDateString('vi-VN')}</small>
                                                </div>
                                                <div class="mb-3">
                                                    <div class="text-warning">
                                                        ${Array(r.rating).fill('<i class="fas fa-star"></i>').join('')}
                                                        ${Array(5 - r.rating).fill('<i class="far fa-star text-muted"></i>').join('')}
                                                    </div>
                                                </div>
                                                <p class="mb-0 text-dark">${r.comment}</p>
                                            </div>
                                        </div>
                                    `).join('') : '<div class="text-center py-4"><i class="fas fa-comment-slash fa-3x text-muted mb-3"></i><h5 class="text-muted">Chưa có đánh giá nào</h5><p class="text-muted">Hãy là người đầu tiên đánh giá sản phẩm này!</p></div>'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('productDetail').innerHTML = detailHtml;
                
                // Store product data globally for variant selection
                window.currentProduct = product;
                
                // Auto-select first variant if only one variant available
                if (product.variants && product.variants.length === 1) {
                    const firstVariant = product.variants[0];
                    setTimeout(() => {
                        selectVariant(firstVariant.id, firstVariant.price, firstVariant.discountPrice || firstVariant.price);
                    }, 100);
                }
                
                // Load similar products
                loadSimilarProducts();
                
                // Auto-open review modal if hash is #review
                if (window.location.hash === '#review') {
                    setTimeout(() => {
                        showReviewModal();
                    }, 500);
                }
            } catch (error) {
                console.error('Error loading product:', error);
                document.getElementById('productDetail').innerHTML = '<div class="col-12"><p class="text-center text-danger">Lỗi tải sản phẩm</p></div>';
            }
        }

        let selectedVariantId = null;
        let selectedVariantStock = 0;

        function selectVariant(variantId, price, discountPrice) {
            selectedVariantId = variantId;
            
            // Find variant stock
            const product = window.currentProduct;
            const variant = product.variants.find(v => v.id === variantId);
            selectedVariantStock = variant ? variant.stockQuantity : 0;
            
            // Update quantity input max value
            const quantityInput = document.getElementById('quantity');
            quantityInput.max = selectedVariantStock;
            quantityInput.value = Math.min(parseInt(quantityInput.value), selectedVariantStock);
            
            // Highlight selected variant
            document.querySelectorAll('#variantsList .card').forEach(card => {
                card.classList.remove('border-primary', 'border-2');
            });
            event.currentTarget.classList.add('border-primary', 'border-2');
            
            // Update stock display
            updateStockDisplay();
        }

        function changeQuantity(delta) {
            const input = document.getElementById('quantity');
            const newValue = parseInt(input.value) + delta;
            const maxStock = selectedVariantStock || 999;
            
            if (newValue >= 1 && newValue <= maxStock) {
                input.value = newValue;
            }
            
            updateStockDisplay();
        }

        function updateStockDisplay() {
            const quantityInput = document.getElementById('quantity');
            const currentQty = parseInt(quantityInput.value);
            
            // Add stock warning if needed
            let stockWarning = document.getElementById('stockWarning');
            if (!stockWarning) {
                stockWarning = document.createElement('small');
                stockWarning.id = 'stockWarning';
                stockWarning.className = 'text-muted';
                quantityInput.parentNode.appendChild(stockWarning);
            }
            
            if (selectedVariantStock > 0) {
                stockWarning.textContent = `Còn lại: ${selectedVariantStock} sản phẩm`;
                stockWarning.className = currentQty > selectedVariantStock ? 'text-danger' : 'text-muted';
            } else {
                stockWarning.textContent = 'Hết hàng';
                stockWarning.className = 'text-danger';
            }
        }

        // Add input validation
        document.addEventListener('DOMContentLoaded', function() {
            const quantityInput = document.getElementById('quantity');
            if (quantityInput) {
                quantityInput.addEventListener('input', function() {
                    const value = parseInt(this.value);
                    const maxStock = selectedVariantStock || 999;
                    
                    if (value > maxStock) {
                        this.value = maxStock;
                        alert(`Chỉ còn ${maxStock} sản phẩm trong kho`);
                    }
                    
                    updateStockDisplay();
                });
            }
        });

        async function addToCart(showAlert = true) {
            // Auto-select first variant if none selected and only one variant available
            if (!selectedVariantId && window.currentProduct && window.currentProduct.variants.length === 1) {
                const firstVariant = window.currentProduct.variants[0];
                selectVariant(firstVariant.id, firstVariant.price, firstVariant.discountPrice || firstVariant.price);
            }
            
            if (!selectedVariantId) {
                alert('Vui lòng chọn phiên bản sản phẩm trước khi thêm vào giỏ hàng');
                return false;
            }

            const quantity = parseInt(document.getElementById('quantity').value);
            
            // Check stock before adding to cart
            if (quantity > selectedVariantStock) {
                alert(`Chỉ còn ${selectedVariantStock} sản phẩm trong kho`);
                return false;
            }

            if (selectedVariantStock <= 0) {
                alert('Sản phẩm đã hết hàng');
                return false;
            }

            try {
                const response = await fetch('/api/cart/items', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include', // Gửi cookies
                    body: JSON.stringify({
                        variantId: selectedVariantId,
                        quantity: quantity
                    })
                });

                if (response.ok) {
                    if (showAlert) {
                        alert('Đã thêm vào giỏ hàng!');
                    }
                    updateCartCount();
                    return true;
                } else if (response.status === 401) {
                    alert('Vui lòng đăng nhập để thêm vào giỏ hàng');
                    window.location.href = '/Identity/Account/Login';
                    return false;
                } else {
                    const errorData = await response.json();
                    alert('Có lỗi xảy ra: ' + (errorData.message || 'Vui lòng thử lại'));
                    return false;
                }
            } catch (error) {
                console.error('Error adding to cart:', error);
                alert('Có lỗi xảy ra. Vui lòng thử lại.');
                return false;
            }
        }

        async function buyNow() {
            // Auto-select first variant if none selected and only one variant available
            if (!selectedVariantId && window.currentProduct && window.currentProduct.variants.length === 1) {
                const firstVariant = window.currentProduct.variants[0];
                selectVariant(firstVariant.id, firstVariant.price, firstVariant.discountPrice || firstVariant.price);
            }
            
            if (!selectedVariantId) {
                alert('Vui lòng chọn phiên bản sản phẩm trước khi mua');
                return;
            }

            const quantity = parseInt(document.getElementById('quantity').value);
            
            // Check stock before buying
            if (quantity > selectedVariantStock) {
                alert(`Chỉ còn ${selectedVariantStock} sản phẩm trong kho`);
                return;
            }

            if (selectedVariantStock <= 0) {
                alert('Sản phẩm đã hết hàng');
                return;
            }

            @if (User.Identity.IsAuthenticated)
            {
                <text>
                // Create direct checkout data
                const checkoutData = {
                    variantId: selectedVariantId,
                    quantity: quantity
                };
                
                // Store in sessionStorage for checkout page
                sessionStorage.setItem('directCheckout', JSON.stringify(checkoutData));
                
                // Redirect to checkout with direct buy flag
                window.location.href = '/Cart/Checkout?direct=true';
                </text>
            }
            else
            {
                <text>
                alert('Vui lòng đăng nhập để mua hàng');
                window.location.href = '/Identity/Account/Login';
                </text>
            }
        }

        async function loadSimilarProducts() {
            try {
                const response = await fetch(`/api/ai/suggest?productId=${productId}`);
                const products = await response.json();
                
                const html = products.slice(0, 4).map(p => `
                    <div class="col-md-3 mb-4">
                        <div class="card h-100 shadow-sm border-0 rounded-4 hover-lift">
                            <img src="${p.imageUrl || '/images/placeholder.jpg'}" class="card-img-top rounded-top-4" alt="${p.name}" style="height: 200px; object-fit: cover;">
                            <div class="card-body p-3">
                                <h6 class="card-title fw-bold">${p.name}</h6>
                                <p class="text-danger fw-bold mb-3">${formatPrice(p.minPrice)}</p>
                            </div>
                            <div class="card-footer bg-transparent border-0 p-3 pt-0">
                                <a href="/Products/Detail/${p.id}" class="btn btn-outline-primary btn-sm w-100 rounded-pill">Xem</a>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('similarProducts').innerHTML = html;
            } catch (error) {
                console.error('Error loading similar products:', error);
            }
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(price);
        }

        function updateCartCount() {
            // Update cart count in navbar
            @if (User.Identity.IsAuthenticated)
            {
                <text>
                fetch('/api/cart', {
                    credentials: 'include'
                })
                .then(r => r.ok ? r.json() : null)
                .then(cart => {
                    if (cart) {
                        const badge = document.getElementById('cartCount');
                        if (badge) badge.textContent = cart.totalItems || 0;
                    }
                })
                .catch(() => {});
                </text>
            }
        }

        loadProductDetail();

        // Review functionality
        let selectedRating = 0;

        function showReviewModal() {
            @if (User.Identity.IsAuthenticated)
            {
                <text>
                // Reset form
                selectedRating = 0;
                document.getElementById('reviewComment').value = '';
                updateStarDisplay();
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('reviewModal'));
                modal.show();
                </text>
            }
            else
            {
                <text>
                alert('Vui lòng đăng nhập để đánh giá sản phẩm');
                window.location.href = '/Identity/Account/Login';
                </text>
            }
        }

        // Star rating functionality
        document.addEventListener('DOMContentLoaded', function() {
            const stars = document.querySelectorAll('.star-rating');
            
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    selectedRating = parseInt(this.dataset.rating);
                    updateStarDisplay();
                });
                
                star.addEventListener('mouseenter', function() {
                    const rating = parseInt(this.dataset.rating);
                    highlightStars(rating);
                });
            });
            
            document.querySelector('.rating-stars').addEventListener('mouseleave', function() {
                updateStarDisplay();
            });
        });

        function highlightStars(rating) {
            const stars = document.querySelectorAll('.star-rating');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.style.color = '#ffc107';
                } else {
                    star.style.color = '#ddd';
                }
            });
        }

        function updateStarDisplay() {
            highlightStars(selectedRating);
        }

        async function submitReview() {
            if (selectedRating === 0) {
                alert('Vui lòng chọn số sao đánh giá');
                return;
            }

            const comment = document.getElementById('reviewComment').value.trim();
            if (!comment) {
                alert('Vui lòng nhập nhận xét');
                return;
            }

            try {
                const response = await fetch('/api/reviews', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        productId: productId,
                        rating: selectedRating,
                        comment: comment
                    })
                });

                if (response.ok) {
                    alert('Cảm ơn bạn đã đánh giá sản phẩm!');
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('reviewModal'));
                    modal.hide();
                    
                    // Reload product to show new review
                    loadProductDetail();
                } else if (response.status === 401) {
                    alert('Vui lòng đăng nhập để đánh giá');
                    window.location.href = '/Identity/Account/Login';
                } else {
                    const errorData = await response.json();
                    alert('Có lỗi xảy ra: ' + (errorData.message || 'Vui lòng thử lại'));
                }
            } catch (error) {
                console.error('Error submitting review:', error);
                alert('Có lỗi xảy ra. Vui lòng thử lại.');
            }
        }
    </script>
}
